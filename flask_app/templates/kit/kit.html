{% extends "layout.html" %}

{% block content %}
<main role="main" class="container">
    <div class="container my-container">
        <div class="row">
            <div class="col-5">
                <h2>Kit</h2>
            </div>
            <div style="-ms-flex: 0 0 14.5%; flex: 0 0 14.5%; max-width: 14.5%;">
                <button type="button" class="btn btn-info button2" data-toggle="modal" data-target="#kit_modal">
                    Print
                    Label
                </button>
            </div>
            <div style="-ms-flex: 0 0 14.5%; flex: 0 0 14.5%; max-width: 14.5%;">
                <button type="button" class="btn btn-info button2" onclick="window.print();return false;">Print
                </button>
            </div>
            <div style="-ms-flex: 0 0 14.5%; flex: 0 0 14.5%; max-width: 14.5%;">
                <form action="/kit_delete/{{ kit.id }}">
                    <button type="submit" class="btn btn-info button2">Delete</button>
                </form>
            </div>
            <div style="-ms-flex: 0 0 14.5%; flex: 0 0 14.5%; max-width: 14.5%;">
                <button type="button" class="btn btn-info button2" onclick="window.history.back();">Back</button>
            </div>
        </div>
        <hr/>
        <div class="row">
            <div class="col-12">
                <table class="table table-hover master">
                    <tr>
                        <th width="30%">Kit Name</th>
                        <td>{{ kit.name }}</td>
                    </tr>
                    <tr>
                        <th>Manufacturer</th>
                        <td>{{ Manufacturer.query.get(kit.manufacturer_fk).name }}</td>
                    </tr>
                    <tr>
                        <th>Box Lot Barcode</th>
                        <td>{{ kit.barcode }}</td>
                    </tr>
                    <tr>
                        <th>Part Number</th>
                        {% if kit.part_num != '-1' %}
                        <td>{{ kit.part_num }}</td>
                        {% elif kit.part_num == '-1' %}
                        <td>N/A</td>
                        {% endif %}
                    </tr>
                    <tr>
                        <th>Lot Number</th>
                        {% if kit.lot_num != '-1' %}
                        <td>{{ kit.lot_num }}</td>
                        {% elif kit.lot_num == '-1' %}
                        <td>N/A</td>
                        {% endif %}
                    </tr>
                    <tr>
                        <th>Date Entered</th>
                        {% if kit.date_entered %}
                        <td>{{ kit.date_entered.strftime("%B %e, %Y") }}</td>
                        {% elif not kit.exp_date %}
                        <td>N/A</td>
                        {% endif %}

                    </tr>
                    <tr>
                        <th>Expiry Date</th>
                        {% if kit.exp_date %}
                        <td>{{ kit.exp_date.strftime("%B %e, %Y") }}</td>
                        {% elif not kit.exp_date %}
                        <td>N/A</td>
                        {% endif %}
                    </tr>
                    <tr>
                        <th>Comments</th>
                        <td>{{ kit.comment }}</td>
                    </tr>
                </table>
                <br/>
            </div>
        </div>
    </div>
</main>
<br/>
<div style="margin-left: 7%; margin-right: 7%">
    <h3>Components</h3>
    <hr/>
    {% for i in range %}
    <h4>
        <button type="button" class="btn btn-default" data-toggle="collapse" data-target="#comp_div{{i}}">Kit UID: {{ kit.date_entered.strftime("%Y-%m-%d %H:%M:%S")}} {{ i+1 }}/{{ kit.quantity }}</button>
    </h4>
    <div id="comp_div{{i}}" class="row collapse">
        <table class="table table-hover">
            <thead>
            <tr>
                <th>Name</th>
                <th width="250px">UID</th>
                <th>Barcode</th>
                <th>Part Number</th>
                <th>Lot Number</th>
                <th style="width:150px">Expiry Date</th>
                <th>Condition</th>
                <th>Label Size</th>
                <th width="100px"></th>
                <th width="100px"></th>
            </tr>
            </thead>
            <tbody>
            {% for component in kit.components[i * kit.components.count() // kit.quantity:(i+1) * kit.components.count() // kit.quantity] %}
            <tr>
                <td>{{ component.name }}</td>
                <td>{{ component.uid }}</td>
                <td>{{ component.barcode }}</td>
                <td>{{ component.part_num }}</td>
                <td>{{ component.lot_num }}</td>
                {% if component.exp_date %}
                <td>{{ component.exp_date.strftime("%B %e, %Y") }}</td>
                {% elif not component.exp_date %}
                <td>N/A</td>
                {% endif %}
                <td>{{ component.condition }}</td>
                <td>{{ component.size.upper() }}</td>
                <td>
                    <button class="btn btn-info" id="{{component.id}},{{component.name}},{{component.barcode}},{{component.part_num}},{{component.lot_num}},{{component.exp_date}},{{component.condition}}" data-toggle="modal" data-target="#comp_modal" onclick="edit_comp(this);">Edit</button>
                </td>
                <td>
                    <form action="/print_kit/{{ kit.id }}" method="post">
                        <input type="hidden" name="comp_print" value="{{component.id}}">
                        <button class="btn btn-info">Print</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    <br/>
    {% endfor %}
</div>

{% endblock content %}

{% block modal %}
<div class="modal fade" id="kit_modal" tabindex="-1" aria-labelledby="kit_modal" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Print Label</h5>
            </div>
            <form id="print" action="/print_kit/{{ kit.id }}" method="post" onkeypress="return event.keyCode != 13;">
                <div class="modal-body">
                    <div class="row my-row">
                        <div class="col-10 form-group">
                            <label for="kit_label">Kit Label Copies:</label>
                        </div>
                    </div>
                    <div class="row my-row">
                        <div class="col-5 form-group">
                            <select class="form-control" id="kit_label_size" name="kit_label_size">
                                <option value="s">Small</option>
                                <option value="m">Medium</option>
                            </select>
                        </div>
                        <div class="col-5 form-group">
                            <input readonly data-prefix="Copies" type="number" value="{{ kit.quantity }}" class="form-control" name="kit_label" id="kit_label"/>
                        </div>
                    </div>
                    <hr/>
                    <div class="row my-row">
                        <div class="col-10 form-group">
                            <label for="kit_label">Component Label Copies:</label>
                        </div>
                    </div>
                    <div class="row my-row">
                        <div class="col-5 form-group">
                            <label for="kit_label">Small Labels:</label>
                        </div>
                        <div class="col-5 form-group">
                            <label for="kit_label">Medium Labels:</label>
                        </div>
                    </div>
                    <div class="row my-row">
                        <div class="col-5 form-group">
                            <input readonly data-prefix="Copies" type="number" value="{{ kit.components.filter_by(size='s').count() // kit.quantity }}" class="form-control"/>
                        </div>
                        <div class="col-5 form-group">
                            <input readonly data-prefix="Copies" type="number" value="{{ kit.components.filter_by(size='m').count() // kit.quantity }}" class="form-control"/>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-info" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-info">Print</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="comp_modal" tabindex="-1" aria-labelledby="kit_modal" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Component</h5>
            </div>
            <form action="/kit/{{ kit.id }}" method="post" onkeypress="return event.keyCode != 13;">
                <div class="modal-body">
                    <input class="form-control" name="comp_id" id="comp_id" type="hidden">
                    <div class="row my-row">
                        <div class="col-4 form-group">
                            <label for="comp_name">Name</label>
                            <input class="form-control" name="comp_name" id="comp_name">
                        </div>
                        <div class="col-5 form-group">
                            <label for="comp_barcode">Barcode</label>
                            <input class="form-control" name="comp_barcode" id="comp_barcode">
                        </div>
                    </div>
                    <div class="row my-row">
                        <div class="col-4 form-group">
                            <label for="part_num">Part Number</label>
                            <input class="form-control" name="part_num" id="part_num">
                        </div>
                        <div class="col-4 form-group">
                            <label for="lot_num">Lot Number</label>
                            <input class="form-control" name="lot_num" id="lot_num">
                        </div>
                        <div class="col-4 form-group">
                            <label for="exp_date">Expiry Date</label>
                            <input class="form-control" name="exp_date" id="exp_date" type="date">
                        </div>
                    </div>
                    <div class="row my-row">
                        <div class="col-6 form-group">
                            <label for="part_num">Condition</label>
                            <input class="form-control" name="comp_condition" id="comp_condition">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-info" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-info">Update</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock modal %}

{% block script %}
<script>
    // Reset modal
    $('.modal').on('hidden.bs.modal', function(){
        $(this).find('form')[0].reset();
        console.log(document.getElementById("print").innerHTML);
        document.getElementById("print").innerHTML = '<div class="modal-body"> <div class="row my-row"> <div class="col-10 form-group"> <label for="kit_label">Kit Label Copies:</label> </div> </div> <div class="row my-row"> <div class="col-5 form-group"> <select class="form-control" id="kit_label_size" name="kit_label_size"> <option value="s">Small</option> <option value="m">Medium</option> </select> </div> <div class="col-5 form-group"> <input readonly data-prefix="Copies" type="number" value="{{ kit.quantity }}" class="form-control" name="kit_label" id="kit_label"/> </div> </div> <hr/> <div class="row my-row"> <div class="col-10 form-group"> <label for="kit_label">Component Label Copies:</label> </div> </div> <div class="row my-row"> <div class="col-5 form-group"> <label for="kit_label">Small Labels:</label> </div> <div class="col-5 form-group"> <label for="kit_label">Medium Labels:</label> </div> </div> <div class="row my-row"> <div class="col-5 form-group"> <input readonly data-prefix="Copies" type="number" value="{{ kit.components.filter_by(size='s').count() // kit.quantity }}" class="form-control"/> </div> <div class="col-5 form-group"> <input readonly data-prefix="Copies" type="number" value="{{ kit.components.filter_by(size='m').count() // kit.quantity }}" class="form-control"/> </div> </div> </div> <div class="modal-footer"> <button type="button" class="btn btn-info" data-dismiss="modal">Cancel</button> <button type="submit" class="btn btn-info">Print</button> </div>'
    });

    function edit_comp(element) {
        var info = element.id.split(",");
        document.getElementById("comp_id").setAttribute("value",info[0]);
        document.getElementById("comp_name").setAttribute("value",info[1]);
        document.getElementById("comp_barcode").setAttribute("value",info[2]);
        document.getElementById("part_num").setAttribute("value",info[3]);
        document.getElementById("lot_num").setAttribute("value",info[4]);
        document.getElementById("exp_date").setAttribute("value",info[5].split(" ")[0]);
        document.getElementById("comp_condition").setAttribute("value",info[6]);
    }

    function option(element) {
        opt = element.value;
        if (opt=="Custom") {
            document.getElementById("hidden").setAttribute("style", "display:inline");
        } else {
            document.getElementById("hidden").setAttribute("style", "display:none");
        }
    };

    function get_comp(element) {
        if (element[element.selectedIndex].value != "") {
            var comp_quantity = {{ kit.components.count() // kit.quantity }};
            for (i = 1; i <= comp_quantity; i++) {
                tag = document.createElement("option");
                tag.setAttribute("value", i);
                tag.innerHTML = "{{ kit.date_entered.strftime("%Y-%m-%d %H:%M:%S")}} " + element[element.selectedIndex].value + "/{{ kit.quantity }} " + i + "/" +comp_quantity;
                document.getElementById("comp_uid" + element.id.substr(-1)).appendChild(tag);
            }
        }
    }

    var counter = 1;

    function clone_element_p(element) {
        var tag = document.createElement("div");
        tag.setAttribute("id", "container_div"+counter)
        tag.setAttribute("style", "padding-bottom:20px")
        tag.innerHTML = '<div class="row my-row"> <div class="col-5 form-group"> <select class="form-control" id="kit_uid' + counter + '" name="kit_uid" onchange="get_comp(this)"> <option value="" selected>Select Kit</option> {% for i in range %} <option value="{{ i+1 }}">{{ kit.date_entered.strftime("%Y-%m-%d %H:%M:%S")}} {{ i+1 }}/{{ kit.quantity }} </option> {% endfor %} </select> </div> <div class="col-5 form-group"> <select class="form-control" id="comp_uid' + counter + '" name="comp_uid"> <option selected></option> </select> </div> <div class="col-2 form-group"> <button type="button" class="btn btn-default" name="clone" id="clone' + counter + '" onclick="clone_element_p(this)"> <i class="fa fa-clone" style="font-size:24px"></i> </button> <button type="button" class="btn btn-default" name="trash" id="trash' + counter + '" onclick="remove_element(this)"> <i class="fa fa-trash-o" style="font-size:24px"></i> </button> </div> </div>'
        document.getElementById("containers_div").appendChild(tag);
        document.getElementById("kit_uid" + counter).value = document.getElementById("kit_uid" + element.id.substr(-1)).value
        get_comp(document.getElementById("kit_uid" + counter));
        document.getElementById("comp_uid" + counter).value = document.getElementById("comp_uid" + element.id.substr(-1)).value
        counter++;
	}

	function add_element_p(element) {
        var tag = document.createElement("div");
        tag.setAttribute("id", "container_div"+counter)
        tag.setAttribute("style", "padding-bottom:20px")
        tag.innerHTML = '<div class="row my-row"> <div class="col-5 form-group"> <select class="form-control" id="kit_uid' + counter + '" name="kit_uid" onchange="get_comp(this)"> <option value="" selected>Select Kit</option> {% for i in range %} <option value="{{ i+1 }}">{{ kit.date_entered.strftime("%Y-%m-%d %H:%M:%S")}} {{ i+1 }}/{{ kit.quantity }} </option> {% endfor %} </select> </div> <div class="col-5 form-group"> <select class="form-control" id="comp_uid' + counter + '" name="comp_uid"> <option selected></option> </select> </div> <div class="col-2 form-group"> <button type="button" class="btn btn-default" name="clone" id="clone' + counter + '" onclick="clone_element_p(this)"> <i class="fa fa-clone" style="font-size:24px"></i> </button> <button type="button" class="btn btn-default" name="trash" id="trash' + counter + '" onclick="remove_element(this)"> <i class="fa fa-trash-o" style="font-size:24px"></i> </button> </div> </div>'
        document.getElementById("containers_div").appendChild(tag);
        counter++;
	}




</script>
{% endblock script %}